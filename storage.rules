rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is owner
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Note: exists() and get() are built-in functions in Storage rules
    // We use them directly - no wrapper needed
    
    // KYC uploads - user can only upload to their own kyc/{uid} path
    match /kyc/{userId}/{allPaths=**} {
      // Read: authenticated users can read
      allow read: if isAuthenticated();
      
      // Write: only owner can upload to their own path
      // Check authentication first, then ownership, then file constraints
      allow write: if request.auth != null &&
                     request.auth.uid == userId &&
                     // File size limit: 10MB
                     request.resource.size < 10 * 1024 * 1024 &&
                     // Only allow image mime types
                     request.resource.contentType.matches('image/.*');
      
      // Delete: only owner
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // User uploads path
    match /user_uploads/{userId}/{allPaths=**} {
      // Read: authenticated users can read
      allow read: if isAuthenticated();
      
      // Write: only owner can upload to their own path
      allow write: if isOwner(userId) &&
                     // File size limit: 10MB
                     request.resource.size < 10 * 1024 * 1024 &&
                     // Only allow image mime types
                     request.resource.contentType.matches('image/.*');
      
      // Delete: only owner or admin
      allow delete: if isOwner(userId);
    }
    
    // Ad request attachments (partners submitting ad requests)
    match /adRequests/{userId}/{allPaths=**} {
      allow read: if isAuthenticated();
      allow write: if request.auth != null &&
                     request.auth.uid == userId &&
                     request.resource.size < 5 * 1024 * 1024 &&
                     request.resource.contentType.matches('image/.*');
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // Auction images path
    match /auctions/{auctionId}/{folder}/{imageId} {
      // Read: authenticated users can read watermarked images
      allow read: if isAuthenticated();
      
      // Write to /original/: authenticated users only
      // Ownership is validated in the service layer before upload
      // This avoids Firestore lookups in Storage rules which can cause -1017 errors
      allow write: if request.auth != null &&
                     // Must be in original folder
                     folder == 'original' &&
                     // File size limit: 5MB
                     request.resource.size < 5 * 1024 * 1024 &&
                     // Only allow image mime types
                     request.resource.contentType.matches('image/(jpeg|jpg|png|webp)');
      
      // Write to /wm/: blocked (only Cloud Function can write)
      allow write: if folder == 'wm' && false;
      
      // Delete: authenticated users (ownership validated in service layer)
      allow delete: if request.auth != null && folder == 'original';
    }
  }
}
