rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is owner
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Note: exists() and get() are built-in functions in Storage rules
    // We use them directly - no wrapper needed
    
    // KYC uploads - user can only upload to their own kyc/{uid} path
    match /kyc/{userId}/{allPaths=**} {
      // Read: authenticated users can read
      allow read: if isAuthenticated();
      
      // Write: only owner can upload to their own path
      // Check authentication first, then ownership, then file constraints
      allow write: if request.auth != null &&
                     request.auth.uid == userId &&
                     // File size limit: 10MB
                     request.resource.size < 10 * 1024 * 1024 &&
                     // Only allow image mime types
                     request.resource.contentType.matches('image/.*');
      
      // Delete: only owner
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // User uploads path
    match /user_uploads/{userId}/{allPaths=**} {
      // Read: authenticated users can read
      allow read: if isAuthenticated();
      
      // Write: only owner can upload to their own path
      allow write: if isOwner(userId) &&
                     // File size limit: 10MB
                     request.resource.size < 10 * 1024 * 1024 &&
                     // Only allow image mime types
                     request.resource.contentType.matches('image/.*');
      
      // Delete: only owner or admin
      allow delete: if isOwner(userId);
    }
    
    // Auction images path
    match /auctions/{auctionId}/{folder}/{imageId} {
      // Read: authenticated users can read watermarked images
      allow read: if isAuthenticated();
      
      // Write to /original/: only auction owner
      allow write: if request.auth != null &&
                     // Must be in original folder
                     folder == 'original' &&
                     // Verify ownership via Firestore (using built-in exists/get)
                     exists(/databases/(default)/documents/auctions/$(auctionId)) &&
                     get(/databases/(default)/documents/auctions/$(auctionId)).data.ownerUid == request.auth.uid &&
                     // File size limit: 5MB
                     request.resource.size < 5 * 1024 * 1024 &&
                     // Only allow image mime types
                     request.resource.contentType.matches('image/(jpeg|jpg|png|webp)');
      
      // Write to /wm/: blocked (only Cloud Function can write)
      allow write: if folder == 'wm' && false;
      
      // Delete: only owner can delete original, Cloud Function handles wm deletion
      allow delete: if request.auth != null &&
                      folder == 'original' &&
                      exists(/databases/(default)/documents/auctions/$(auctionId)) &&
                      get(/databases/(default)/documents/auctions/$(auctionId)).data.ownerUid == request.auth.uid;
    }
  }
}
